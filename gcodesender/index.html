<html>
	<head>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
		<style>
			#log{
				height:50vh;
				overflow: auto;
				padding:10px;
			}
			#control-panel{
				height:50vh;
			}
			#gcode-sender{
				padding:10px;
				padding-bottom:5px;
			}
			#controls{
				padding:10px;
			}
			#msg{
				margin:bottom:5px;
				height:75%;
				width:90%;
			}
			button{
				padding-left:10px;
				padding-right:10px;
			}
		</style>
	</head>
	<body>
		
		<!-- Progress Log -->
		<div id="log">
			G Code Sender v2.0<br>
			By Amey Kamat and Tanay Gahlot</br> 
		</div>
		<!-- End Progress Log -->
		
		<!-- Control Panel -->
		<div id="control-panel" style="margin:0px; background-color:lightgray">
			
			<!-- G-Code Sender Interface -->
			<div id="gcode-sender" class="col-md-6">
				<form id="form">
					<!-- Textarea to enter G-Code -->
					<textarea id="msg" placeholder="Enter G-Code here."></textarea><br><br>
					<!-- Carve Button -->
					<input type="submit" value="Carve!" id="carve" disabled/>
					<!-- Stop Carving Button -->
					<button type="button" value="stop" id="stop" onclick="sendCommand(this)" disabled>Stop (Not Tested)</button>
				</form>
			</div>
			<!-- End G-Code Sender Interface -->
			
			<!-- Tool Movement Controls -->
			<div class="col-md-6">
				
				<!-- Open and Close Port and Zero Position Controls  -->
				<div class="row" style="text-align:center; padding-top:10px;">
					<button type="button" value="open" id="open" onclick="sendCommand(this)">Open Port</button>
					<button type="button" value="zero" id="zero" onclick="sendCommand(this)">Zero Position</button>
					<button type="button" value="close" id="close" onclick="sendCommand(this)" disabled>Close Port</button>
				</div>
				
				<!-- Tool Movement Controls -->
				<div class="row" style="text-align:center;padding-top:20px;">
					Offset: <input type="text" id="offset" value="1" style="width:50px"/>
				</div>
				<div class="row">
					<div class="col-md-6" style="padding-top:50px; padding-bottom:50px;">
						<div class="row" style="text-align:center">
							<button type="button" value="forward" id="zero" onclick="sendCommand(this)">&uarr;</button>
						</div>
						<div class="row">
							<div id="controls" class="col-md-6" style="text-align:right">
								<button type="button" value="left" id="zero" onclick="sendCommand(this)">&larr;</button>
							</div>
							<div id="controls" class="col-md-6" style="text-align:left">
								<button type="button" value="right" id="zero" onclick="sendCommand(this)">&rarr;</button>
							</div>
						</div>
						<div class="row" style="text-align:center">
							<button type="button" value="backword" id="zero" onclick="sendCommand(this)">&darr;</button>
						</div>
					</div>
					<div class="col-md-6" style="padding-top:50px; padding-bottom:50px;">
						<div class="row" style="text-align:center">
							<button type="button" value="up" id="zero" onclick="sendCommand(this)">&uarr;</button>
						</div>
						<div class="row" style="text-align:center; padding:10px">
							Z-Axis
						</div>
						<div class="row" style="text-align:center">
							<button type="button" value="down" id="zero" onclick="sendCommand(this)">&darr;</button>
						</div>
					</div>
				</div>
				<div id="status" class="row" style="text-align:center;padding-top:20px;"></div>
				<div id="progress" class="row" style="text-align:center;padding-top:20px;"></div>
			</div>
		</div>
		
	

		<script>
			
			/* Elements of Progress Bar */
			var total;
			var completed;

			/* Setting all attributes governing the gcode sender */
			var conn;
			var messageBuffer = "";
			var portName = "";
			var baudRate = "9600";
			var gcode = [];
			var isStop = false; 

			/* Utility functions to print to console and display */
			function writeLog(msg) {
				var log = $("#log");
				var d = log[0];
				var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;
				$("<div>"+ msg +"</div>").appendTo(log);
				if (doScroll) {
					d.scrollTop = d.scrollHeight - d.clientHeight;
				}
			}
			
			function writeConsole(value){
				console.log(value)
			}
			
			function writeStatus(msg){
				var status = $("#status");
				status.text(msg);
			}
			
			/* Writes and Increments Progress */
			function writeAndIncrProgressBar(){
				var progress = $("#progress");
				
				if(total > 0){
					progress.text(Math.round(completed*100/total) + "% Completed")
					completed++;
				}
			}
			
			function setButtonValue(carveDis, stopDis, openDis, closeDis){
				$("#close").attr('disabled',closeDis);
				$("#carve").attr('disabled',carveDis);
				$("#stop").attr('disabled',stopDis);
				$("#open").attr('disabled',openDis);
			}

			/* Send a message */
			function sendMessage(msg){
				writeConsole("Sending Messge : " + msg);
				writeLog("Sending Messge : " + msg);
				conn.send(msg + "\n")
			}
			
			/* Split gcode string into array of gcodes */
			function splitGcode(){
				gcode = gcode.split("\n");
			}
			
			/* Functions to send typical messages */
			function G0(x, y, z){
				sendMessage("send " + portName + " G0 X" + x + " Y" + y + " Z" + z);
			}
			
			function G1(x, y, z){
				sendMessage("send " + portName + " G1 X" + x + " Y" + y + " Z" + z);
			}
			
			function G92(x, y, z){
				sendMessage("send " + portName + " G92 X" + x + " Y" + y + " Z" + z);
			}
			
			function G91(){
				sendMessage("send " + portName + " G91");
			}
			
			function close(port){
				var p = port || portName;
				sendMessage("close " + p);
			}
			
			function list(){
				sendMessage("list");
			}
			
			function send(msg){
				sendMessage("send " + portName + " " + msg);
			}
			
			/* Abstractions for over basic g-codes  to do specific tasks */
			function setZero(){
				G92(0, 0, 0);
			}
			
			function setRelativeCoord(){
				G91();
			}
			
			function moveUp(offset){
				G0(0, 0, offset);
			}
			
			function moveDown(offset){
				G0(0, 0, -offset);
			}
			
			function moveLeft(offset){
				G0(-offset, 0 , 0);
			}
			
			function moveRight(offset){
				G0(offset, 0, 0);
			}
			
			function moveForward(offset){
				G0(0, offset, 0);
			}
			
			function moveBackward(offset){
				G0(0, -offset, 0);
			}
			
			function openPort(){
				list();
			}
			
			function closePort(){
				gcode = [];
				close();
			}
			
			function stop(){
				isPort = true;
				closePort();
			}
			
			/* Function to handle test commands from UI */
			function sendCommand(btn){
				var dir = btn.value;
				var offset = $("#offset").val();
				
				total = 0;
				
				writeConsole(dir + " with offset " + offset);
				
				/* Validation for offset and ignore validation for non directional commands */
				if((isNaN(offset) || offset=="") && (dir != "zero" && dir != "close" && dir != "stop" && dir != "open")){
					writeConsole(offset + " is not a number.")
					writeLog("Enter a valid offset");
					return;
				}
				
				if(dir == "zero")													
					setZero();
				if(dir == "up")														
					moveUp(offset);
				if(dir == "down")													
					moveDown(offset);
				if(dir == "left")													
					moveLeft(offset);
				if(dir == "right")													
					moveRight(offset);
				if(dir == "forward")												
					moveForward(offset);
				if(dir == "backword")												
					moveBackward(offset)
				if(dir == "close")
					closePort();
				if(dir == "open")
					openPort();
				if(dir == "stop")
					stop();
			}

			/* Event Handler to handle the submitted gcode */
			$("#form").submit(function(e) {
				e.preventDefault();
				var msg = $("#msg");
				
				if (!conn) {
					return false;
				}
				if (!msg.val()) {
					return false;
				}
				
				gcode = msg.val();
				
				/* Break down gcode and send first message to CNC */
				splitGcode();
				
				total = gcode.length;
				completed = 0;
				
				send(gcode.shift());
				
				return false
			});

			/* Getter for the buffer for response */
			function getMessageBuffer(){
				var value = messageBuffer;
				messageBuffer = "";
				return value;
			}

			/* Setter for the buffer for response */
			function setMessageBuffer(value){
				messageBuffer = value;
			}

			/* Poll all the ports returned by list command */
			function portSelector(data){
				var listOfPorts = data["SerialPorts"];
				if(listOfPorts.length == 0){
					writeConsole("No serial ports detected.")
					writeLog("No serial ports detected.")
					return;
				}
				for(var i=0; i<listOfPorts.length; i++){
					sendMessage("open " + listOfPorts[i].Name + " " + baudRate);
				}
			}

			/* Show Error */
			function showError(data){
				writeLog(data.Error);
				writeConsole(data.Error);
			}


			/* Handle Cmd response */
			function showCmd(response){
				if(response.Cmd == "OpenFail"){
					/* Opening operation failed for a port */
					writeLog(response.Desc + " for port " + response.Port);
					
					//Need to be handled properly
					close(response.Port);
				}
				else if(response.Cmd == "Open"){
					/* Port has been opened */
					writeLog(response.Desc);
				}
				else if(response.Cmd == "Close"){
					/* Port has been closed */
					writeLog(response.Desc);
					setButtonValue(true, true, false, true);
					
					/* If stop mode activated */
					if(isStop){
						sendMessage("list");
						isStop = false;
					}
					
					total = 0;
					
				}
				/*else{
					writeLog(response.Desc);
					writeConsole(response);
				}*/
			}


			if(window["WebSocket"]){

				/* Connect to standard web socket */
				conn = new WebSocket("ws://localhost:8989/ws");
				
				conn.onopen = function(event) {
					writeConsole(event);
					writeLog("Connection with serial JSON server established successfully.");					
				};
				
				conn.onerror=function(event){
					writeConsole(event);
					writeLog("Connection was refused. Ensure that serial JSON server is running.");					
				};
				
				conn.onclose=function(event){
					writeConsole(event);
					writeLog("Connection to server disconnected.");	
					setButtonValue(true, true, false, true);
				};
				
				writeConsole(conn);
				
				/* Event Listener for custom event get to for message out of chunks */
				conn.addEventListener("get", function(e){
					var message = messageBuffer;
					writeConsole(message);
					
					/* If Gcode array is not null */
					if(gcode[0]){
						/* Send next gcode */
						send(gcode.shift());
					}
				});
				
				/* Do this on response */
				conn.onmessage = function(e){
					var message = getMessageBuffer();
					var response = JSON.parse(e.data);
					var key = Object.keys(response)[0];
					
					writeConsole(e.data);
					
					/* All possible responses frm CNC listed down */ 
					if(key == "Version"){
						writeLog("Version: " + response.Version);
					}
					else if(key == "Commands"){}
					else if(key == "Hostname"){
						writeLog("HostName: " + response.Hostname);
						list();
					}
					else if(key == "Error"){
						showError(response);
					}
					else if(key == "SerialPorts"){
						portSelector(response);
					}
					else if(key == "Cmd"){
						showCmd(response);
					}
					else if(key == "P"){
					
						/* Message received in chunks. Proceed to message buffer */
						message = message + response.D;
						setMessageBuffer(message);
						
						/* If the server is initialised */
						if(message == "\r\nGrbl 0.8c ['$' for help]\r\n"){
							portName = response.P;

							writeConsole("Setting Active Port: " + portName);
							writeLog("Setting Active Port: " + portName);

							setButtonValue(false, false, true, false);
							
							/* Set relative coordinates */
							setRelativeCoord();
						}
						else if(message == "ok\r\n"){	/* End of response detected */
							
							writeAndIncrProgressBar();
							
							/* Fire custom get event */
							var event = new CustomEvent('get');
							e.currentTarget.dispatchEvent(event);
						}
					}
					else{
						writeLog(e.data);
						writeConsole(e.data);
					}
				};
			}
		</script>

	</body>
</html>
